<template>
  <div class="edit right-container">
    <Menu />
    <Header />
    <!-- 编辑区域 -->
    <form class="post-form">
      <div class="form-group col-12">
        <input
          type="text"
          class="title"
          v-model="post.title"
          placeholder="文章标题"
        >
      </div>
      <div class="form-group col-12 no-overflow">
        <Select
          class="category"
          :selected="post.categoryId"
          :options="categories"
          @selectedValue="changeSelectedCategory"
        />
        <button
          class="btn-default add-category"
          @click="addCategory"
        >添加分类</button>
      </div>
      <div class="form-group col-12 no-overflow">
        <div class="tag-group">
          <!-- 标签列表 -->
          <div
            class="tag-list"
            ref="tagList"
          >
            <span
              class="tag"
              v-for="(tag, index) in tags"
              :key="tag.id"
            >
              {{ tag.name }}
              <svg
                class="icon"
                aria-hidden="true"
                @click.stop="deleteTag(tag, index)"
              >
                <use xlink:href="#icon-delete"></use>
              </svg>
            </span>
          </div>
          <!-- 添加标签 -->
          <input
            type="text"
            v-model.trim="newTag"
            ref="inputTag"
            placeholder="标签，可使用 逗号, 分号; 分割"
          >
          <ul
            class="search-tag-list"
            ref="searchTagList"
            v-show="searchTags.length > 0"
          >
            <li
              class="search-tag"
              v-for="tag in searchTags"
              :key="tag.id"
              @click="selectTag(tag)"
              v-html='filterTag(tag.name)'
            >
            </li>
          </ul>
        </div>
      </div>
      <div class="form-group col-12">
        <Markdown
          :content="post.content"
          @syncContent="syncContent"
        />
      </div>
    </form>
    <!-- 按钮区域 -->
    <div class="btn-group">
      <button
        class="btn-default btn-primary"
        @click="publishPost"
      >{{$route.params.id?'完成编辑':'完成发布'}}</button>
      <button
        class="btn-default"
        @click="draftPost"
      >保存草稿</button>
    </div>
  </div>
</template>

<script>
import api from "api/api"
export default {
  components: {
    Menu: () => import("components/menu/menu"),
    Header: () => import("components/header/header"),
    Markdown: () => import("components/markdown"),
    Select: () => import("components/select"),
  },
  name: '',
  data() {
    return {
      post: {
        title: '',
        content: '',
        categoryId: 0,
        status: ''
      },
      categories: [{
        id: 0,
        name: '请选择文章分类'
      }],
      tags: [],
      newTag: '',
      searchTags: [],
      isFirstUpdatePostChange: false,
      isFirstUpdateTagsChange: false,
      isLoading: false
    }
  },
  watch: {
    $route: function () {
      if (this.$route.params.id) {
        this.getPostById(this.$route.params.id);
      } else {
        this.post = {
          title: '',
          content: '',
          categoryId: 0,
          status: ''
        };
        this.tags = [];
      }
    },
    newTag: async function () {
      if (this.newTag.indexOf(',') > -1 || this.newTag.indexOf('，') > -1 || this.newTag.indexOf(';') > -1 || this.newTag.indexOf('；') > -1) {
        let tagTemp = this.newTag.replace(',', '').replace('，', '').replace(';', '').replace('；', '');
        // 先判断当前标签是否已存在，已存在则不添加
        let isNew = true;

        for (let tag of Object.values(this.tags)) {
          if (tag.name === tagTemp) {
            isNew = false;
            this.newTag = '';
          }
        }
        if (isNew) {
          if (this.tags.length >= 5) {
            this.$message.showMessage({
              type: 'warning',
              content: '最多添加5个标签'
            });
          } else {
            let res = await api.addNewTagWhenPost(tagTemp);
            if (res.success === 1) {
              this.tags.push({
                id: res.newId,
                name: tagTemp
              });
              this.newTag = '';
            }
          }
        } else if (this.newTag) {
          this.$refs.searchTagList.style.left = (this.$refs.tagList.offsetWidth + 7) + 'px';
          let res = await api.searchTagByName(this.newTag);
          if (res.success === 1) {
            this.searchTags = res.tags;
          } else {
            this.searchTags = [];
          }
        }
      }
    },
    post: {
      handler: function (val, oldVal) {
        console.log(this.isFirstUpdatePostChange)
        if (this.isFirstUpdatePostChange) {
          this.isFirstUpdatePostChange = false;
        } else {
          let newPost = this.createSavePost();
          this.$socket.emit('saveDraftPost', newPost);
        }
      },
      deep: true
    },
    tags: function (val, oldVal) {
      if (this.isFirstUpdateTagsChange) {
        this.isFirstUpdateTagsChange = false;
      } else {
        let newPost = this.createSavePost();
        this.$socket.emit('saveDraftPost', newPost);
      }
    },
    sockets: {
      connect: function () {
        console.log('socket connected');
      },
      getDraftPost: function (val) {
        if (val) {
          // let serverPost = JSON.parse(val);
          Object.assign(this.post, val);
          this.tags = val.tags || [];
        }
      }
    }
  },
  methods: {
    filterTag(tag) {
      return tag.replace(this.newTag, `<strong>${this.newTag}</strong>`);
    },
    syncContent(content) {
      this.post.content = content;
    },
    changeSelectedCategory(catId) {
      console.log(catId)
      this.post.categoryId = catId;
      console.log(this.post);
    },
    async getPostById(id) {
      let res = await api.getPostById(id);
      if (res.success === 1) {
        this.isFirstUpdatePostChange = true;
        this.isFirstUpdateTagsChange = true;
        this.post = res.post;
        this.tags = res.tags;
      }
    },
    async getCategories() {
      let res = await api.getCategories();
      if (res.success === 1) {
        let categories = res.categories;
        categories.unshift({
          id: 0,
          name: '请选择文章分类'
        });
        this.categories = categories;
      }
    },
    async publishPost() {
      if (this.isLoading) {
        return;
      }
      if (!this.post.title || !this.post.content) {
        this.$message.showMessage({
          type: 'warning',
          content: '标题和内容不能同时为空'
        });
        return
      }
      this.isLoading = true;
      this.post.status = 'PUBLISHED';
      let newPost = Object.assign({}, this.post);
      newPost.tags = this.tags;
      let res = null;
      if (this.$route.params.id) {
        res = await api.updatePost(this.$route.params.id, newPost);
      } else {
        res = await api.addPost(newPost);
      }
      if (res.success === 1) {
        this.$socket.emit('clearDraftPost');
        this.$message.showMessage({
          type: 'success',
          content: '文章发布成功'
        });
        this.$router.push({ path: '/postlist' });
      }
      this.isLoading = false;
    },
    async draftPost() {
      if (this.isLoading) {
        return;
      }
      this.isLoading = true;
      this.post.status = 'DRAFT';
      let newPost = this.createSavePost();
      let res = null;
      if (this.$route.params.id) {
        res = await api.updatePost(this.$route.params.id, newPost);
      } else {
        res = await api.addPost(newPost);
      }
      if (res.success === 1) {
        this.$socket.emit('clearDraftPost');
        this.$message.showMessage({
          type: 'success',
          content: '文章保存草稿成功'
        });
        this.$router.push({ path: '/postlist' });
      }
      this.isLoading = false;
    },
    deleteTag(index) {
      this.tags.splice(index, 1);
    },
    selectTag(tag) {
      // 先判断当前标签是否已存在，已存在则不添加
      let isNew = true;
      for (let tagTemp of Object.values(this.tags)) {
        if (tagTemp.name === tag.name) {
          isNew = false;
        }
      }
      if (isNew) {
        if (this.tags.length >= 5) {
          this.$message.showMessage({
            type: 'warning',
            content: '最多添加5个标签'
          });
        } else {
          this.tags.push(tag);
        }
      }
      this.newTag = '';
      this.searchTags = [];
    },
    addCategory() {
      this.$msgBox.showMsgBox(_msg_.messagebox.addCategory)
        .then(async (val) => {
          let res = await api.addNewCategory(val);
          if (res.success === 1) {
            this.categories.push({
              id: res.newId,
              name: val
            });
            this.$message.showMessage({
              type: 'success',
              content: '添加分类成功'
            });
          } else {
            this.$message.showMessage({
              type: 'error',
              content: res.message
            });
          }
        }).catch(() => {
          console.log('cancel');
        });
    },
    getDraftPost() {
      this.$socket.emit('getDraftPost');
    },
    createSavePost() {
      let savePost = {
        id: this.post.id || 0,
        title: this.post.title,
        content: this.post.content,
        categoryId: this.post.categoryId,
        status: this.post.status,
        poster: this.post.poster,
        tags: this.tags
      };
      return savePost;
    }
  },
  created() {
    this.getCategories();
    if (this.$route.params.id) {
      this.getPostById(this.$route.params.id);
    } else {
      this.getDraftPost();
    }
  },
  mounted() {

  },
}
</script>

<style scoped lang='less'>
@import "~common/styles/vars";
.edit {
  position: relative;
  .post-form {
    margin: 0 -1em 5em;
    .no-overflow {
      overflow: visible;
    }
    .tag-list {
      float: left;
    }
    .tag-group {
      position: relative;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 0.2em;
      outline: none;
      box-sizing: border-box;
      span {
        position: relative;
        float: left;
        margin: 0.5em 0 0 1em;
        padding: 0 1.6em 0 0.5em;
        line-height: 2em;
        background: @base-color;
        color: #fff;
        border-radius: 0.2em;
        .icon {
          position: absolute;
          top: 0.7em;
          right: 0.2em;
          width: 0.6em;
          height: 0.6em;
          color: red;
          vertical-align: -0.05em;
          margin-right: 0.2em;
        }
      }
      input {
        border: none;
        width: auto;
        min-width: 20em;
      }
      .search-tag-list {
        position: absolute;
        top: 100%;
        left: 1em;
        margin-top: 0.15em;
        padding-left: 1em;
        color: #555;
        line-height: 2;
        min-width: 15em;
        z-index: 999;
        background: #eff2f7;
        box-shadow: 0 0.4em 0.8em 0 rgba(0, 0, 0, 0.18);
      }
    }
    .category {
      width: calc(100% - 9em);
    }
    .add-category {
      position: absolute;
      top: 0.15em;
      right: 0.7em;
    }
  }
  .btn-group {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    z-index: 999;
    padding: 1em 0;
    button {
      float: right;
      margin-right: 1em;
    }
  }
}
</style>
